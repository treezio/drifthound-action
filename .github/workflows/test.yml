name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # Unit tests for shell scripts
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

          # Install yq
          YQ_VERSION="v4.35.1"
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

      - name: Run parse-config.sh tests
        run: |
          chmod +x tests/unit/test-parse-config.sh
          ./tests/unit/test-parse-config.sh

  # Integration test - parse configuration
  integration-parse-config:
    name: Integration - Parse Config
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test parsing with environment filter
        env:
          CONFIG_FILE: "drifthound.yaml.example"
          WORKING_DIR: "."
          ENVIRONMENT_FILTER: "production"
          GITHUB_OUTPUT: "/tmp/github_output"
        run: |
          # Install dependencies
          sudo apt-get update && sudo apt-get install -y jq
          YQ_VERSION="v4.35.1"
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

          # Run parse script
          bash scripts/parse-config.sh

          # Verify output
          if [[ -f "$GITHUB_OUTPUT" ]]; then
            echo "✓ GITHUB_OUTPUT file created"

            # Extract scopes count
            SCOPES_JSON=$(awk '/^scopes<<EOF$/,/^EOF$/' "$GITHUB_OUTPUT" | sed '1d;$d')
            SCOPE_COUNT=$(echo "$SCOPES_JSON" | jq '. | length')

            echo "Found $SCOPE_COUNT production scope(s)"

            if [[ "$SCOPE_COUNT" -gt 0 ]]; then
              echo "✓ Successfully parsed production scopes"
            else
              echo "✗ No production scopes found"
              exit 1
            fi
          else
            echo "✗ GITHUB_OUTPUT file not created"
            exit 1
          fi

  # Integration test - matrix generation
  integration-matrix:
    name: Integration - Matrix Generator
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate matrix for production environment
        id: matrix
        uses: ./matrix
        with:
          config-file: 'drifthound.yaml.example'
          environment: 'production'

      - name: Verify matrix output
        run: |
          echo "Matrix: ${{ steps.matrix.outputs.matrix }}"
          echo "Scope count: ${{ steps.matrix.outputs.scope-count }}"

          if [[ "${{ steps.matrix.outputs.scope-count }}" -gt 0 ]]; then
            echo "✓ Matrix generated successfully"
          else
            echo "✗ Matrix generation failed"
            exit 1
          fi

  # Lint shell scripts
  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run shellcheck
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck

          echo "Checking shell scripts..."
          shellcheck scripts/*.sh tests/unit/*.sh || true
          echo "✓ Shellcheck complete"

  # Test documentation links
  check-docs:
    name: Check Documentation Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify documentation structure
        run: |
          echo "Checking documentation structure..."

          # Check that README exists in root
          if [[ ! -f "README.md" ]]; then
            echo "✗ README.md missing from root"
            exit 1
          fi
          echo "✓ README.md exists in root"

          # Check that docs folder exists
          if [[ ! -d "docs" ]]; then
            echo "✗ docs/ folder missing"
            exit 1
          fi
          echo "✓ docs/ folder exists"

          # Check that expected docs exist
          REQUIRED_DOCS=("QUICKSTART.md" "ENVIRONMENT-AUTH.md" "CONTRIBUTING.md" "CHANGELOG.md" "CLI-IMPROVEMENTS.md")
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [[ ! -f "docs/$doc" ]]; then
              echo "✗ docs/$doc missing"
              exit 1
            fi
            echo "✓ docs/$doc exists"
          done

          echo "✓ All documentation files present"

  # Summary job
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-parse-config, integration-matrix, shellcheck, check-docs]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.unit-tests.result }}" == "success" ]]; then
            echo "✅ Unit Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Unit Tests: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.integration-parse-config.result }}" == "success" ]]; then
            echo "✅ Integration (Parse Config): Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Integration (Parse Config): Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.integration-matrix.result }}" == "success" ]]; then
            echo "✅ Integration (Matrix): Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Integration (Matrix): Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.shellcheck.result }}" == "success" ]]; then
            echo "✅ Shellcheck: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Shellcheck: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.check-docs.result }}" == "success" ]]; then
            echo "✅ Documentation Check: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Documentation Check: Failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if any test failed
        if: |
          needs.unit-tests.result != 'success' ||
          needs.integration-parse-config.result != 'success' ||
          needs.integration-matrix.result != 'success' ||
          needs.shellcheck.result != 'success' ||
          needs.check-docs.result != 'success'
        run: |
          echo "One or more tests failed"
          exit 1
